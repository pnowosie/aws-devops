# Moduł 11

## Przygotowanie nowego środowiska

Ponieważ moje obecne środowisko `dev` jest zablokowane jeszcze kilka dni (database credential nie może być utworzony przez stack, bo już istnieje "pending deletion"),
clonuję nowe środowisko `ndev`. Jednocześnie ponieważ gałęzie w git-cie są tanie, wolę mieć nową gałąź `ndevelopment` przechowującą pliki dla tego środowiska
zamiast trzymać je razem z obecnym środowiskiem.

### Przygotowanie gałęzi w CodeCommit

W repozytorium z infrastrukturą odpalam
```bash
git checkout development
git checkout -b ndevelopment
git push -u origin ndevelopment 
```

<img width="806" alt="obraz" src="https://user-images.githubusercontent.com/1813036/127761778-337a6728-e7d9-479f-80c6-8833ce35ac27.png">

### Klonuję środowisko

Skrypt klonujący z obecnymi parametrami utworzy mi środowisko o nazwie `ndev`
```bash
git checkout -b feature/ndev-env-clone
bash memes-generator/cicd/scripts/clone-environment.sh
find . -type f -name "*-dev.json" -exec rm -f {} \;
git add .
git commit -m "Env: environment clone dev -> ndev"
git push origin feature/ndev-env-clone
```

W efekcie dostaję czystą gałąź tylko z parametrami dla środowiska `ndev`
<img width="806" alt="obraz" src="https://user-images.githubusercontent.com/1813036/127761942-4dec650a-bbac-4d0a-a83f-f31b0dfedf3e.png">

### Scalam do gałęzi `ndevelopment`

Tworzę **Pull Request** z powyższej feature-branch na przygotowaną gałąź z nowym środowiskiem.
(Ponieważ CLI jest bliższe mojemu :heart:)
```bash
aws codecommit create-pull-request \
   --title "NDev - environment" \
   --targets repositoryName=memes-generator-shared-cicd-infra,sourceReference=feature/ndev-env-clone,destinationReference=ndevelopment \
   --region eu-west-1
```
<img width="1328" alt="obraz" src="https://user-images.githubusercontent.com/1813036/127762209-97030af0-6119-49df-8c65-b7c4427f1700.png">



Zmieniam w szablonie `database.yaml` intristic function na bardziej naturalne w tym przypadku `Ref`

<img width="805" alt="obraz" src="https://user-images.githubusercontent.com/1813036/127761135-c29c0f56-4207-401f-a1f4-19fd21149ea5.png">
